<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ravenclaw - Квест "Гнев Кернунна"</title>
    <link rel="icon" type="image/x-icon" href="faviconTT.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sofia+Sans+Extra+Condensed:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            background: url('https://radika1.link/2025/08/01/ra_forum_background_img_08c2550a6ef5a7985.jpg') center center fixed;
            background-size: auto;
            background-repeat: repeat;
            min-height: 100vh;
            color: #fff;
            font-size: 18px;
        }

        header {
            background: rgba(0, 0, 0, 0.8) url('https://radika1.link/2025/08/01/ra_forum_background_img_08c2550a6ef5a7985.jpg') center center;
            background-size: auto;
            background-repeat: repeat;
            border-bottom: 0px double #8A6A3E;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        header::before {
            display: none; 
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
        }

        header > * {
            position: relative;
            z-index: 2;
        }

        h1 {
            font-family: 'Permanent Marker', cursive;
            font-size: 3.5em;
            color: #8A6A3E;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .subtitle {
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            color: #C9A86A;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(21, 39, 63, 0.9);
            padding: 10px;
            border-radius: 8px;
            border: 2px double #8A6A3E;
        }

        button.tab-btn {
            padding: 12px 20px;
            background: #5D4C3A;
            color: #E8D8C0;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        button.tab-btn:hover {
            background: #6B5A48;
            transform: translateY(-2px);
        }

        button.tab-btn.active {
            background: #8A6A3E;
            color: #fff;
            border-color: #5D4C3A;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(21, 39, 63, 0.95);
            border: 2px double #8A6A3E;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card.purple {
            border-color: #8A6A3E;
        }

        .card.green {
            border-color: #8A6A3E;
        }

        h2 {
            color: #C9A86A;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-weight: 600;
        }

        .card.purple h2 {
            color: #C9A86A;
        }

        .card.green h2 {
            color: #C9A86A;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: rgba(21, 39, 63, 0.8);
            border: 1px solid #8A6A3E;
            border-radius: 5px;
            color: #fff;
            font-size: 1em;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder {
            color: #999;
        }

        button.add-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 10px 20px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 10px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-size: 1.1em;
        }

        button.add-btn:hover {
            background: #6B5A48;
            transform: scale(1.05);
        }

        button.delete-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 6px 12px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        button.delete-btn:hover {
            background: #6B5A48;
        }

        .item-list {
            list-style: none;
        }

        .item-list li {
            background: rgba(21, 39, 63, 0.6);
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #8A6A3E;
        }

        .item-list li.purple-item {
            border-left-color: #8A6A3E;
        }

        .item-list li.green-item {
            border-left-color: #8A6A3E;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #15273F;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #8A6A3E;
            color: #C9A86A;
            font-weight: 600;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        .card.green th {
            border-bottom-color: #8A6A3E;
            color: #C9A86A;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #8A6A3E;
            background: #15273F;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        tr:hover {
            background: rgba(138, 106, 62, 0.2);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .anger-display {
            background: rgba(21, 39, 63, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #8A6A3E;
        }

        .anger-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 1.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .anger-stat:last-child {
            border-bottom: none;
        }

        .anger-stat span:last-child {
            font-weight: bold;
            color: #C9A86A;
        }

        .card.purple .anger-stat span:last-child {
            color: #C9A86A;
        }

        .card.green .anger-stat span:last-child {
            color: #C9A86A;
        }

        .anger-value {
            font-size: 1.3em !important;
            color: #B22222 !important;
        }

        .anger-value.high {
            color: #B22222 !important;
        }

        .anger-value.medium {
            color: #CD5C5C !important;
        }

        .anger-value.low {
            color: #6B8E23 !important;
        }

        .anger-bar {
            width: 100%;
            height: 30px;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #CD5C5C 100%);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .anger-fill {
            height: 100%;
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 50%, #8FBC8F 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            position: absolute;
            right: 0;
        }

        .chart-container {
            background: rgba(21, 39, 63, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #8A6A3E;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 12px 0;
            gap: 10px;
        }

        .chart-label {
            min-width: 150px;
            text-align: right;
            font-size: 0.95em;
        }

        .chart-bar-visual {
            flex: 1;
            height: 25px;
            background: linear-gradient(90deg, #5D4C3A 0%, #8A6A3E 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .chart-bar-visual.mercy {
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 100%);
        }

        .chart-bar-visual.anger {
            background: linear-gradient(90deg, #8B4513 0%, #CD5C5C 100%);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .status-badge.rage {
            background: #B22222;
            color: white;
        }

        .status-badge.growing {
            background: #CD5C5C;
            color: white;
        }

        .status-badge.calming {
            background: #8A6A3E;
            color: white;
        }

        .status-badge.peaceful {
            background: #6B8E23;
            color: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .input-group input,
        .input-group select {
            margin: 0;
        }

        .input-group input {
            flex: 1;
        }

        .export-import-section {
            background: rgba(21, 39, 63, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px double #8A6A3E;
        }

        .export-import-section button {
            margin: 5px;
        }

        #importFile {
            display: none;
        }

        .participant-view-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #participantAngerContainer {
            width: 100%;
            max-width: 600px;
        }

        .anger-bar-participant {
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 35%, #CD5C5C 65%, #D2691E 100%);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            position: relative;
            border: 2px solid #8A6A3E;
        }

        .mercy-fill-participant {
            height: 100%;
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 50%, #8FBC8F 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
        }

        .mercy-fill-participant span {
            color: white;
            font-weight: bold;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 10;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .screenshot-btn {
            background: linear-gradient(135deg, #5D4C3A 0%, #8A6A3E 100%);
            color: #E8D8C0;
            padding: 12px 30px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1.1em;
            transition: all 0.3s;
            margin-top: 20px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        .screenshot-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(93, 76, 58, 0.6);
        }

        .rating-container {
            width: 100%;
            max-width: 600px;
            background: rgba(21, 39, 63, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #8A6A3E;
            margin-top: 20px;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .rating-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 8px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .rating-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .leader-badge {
            color: #FFD700;
            font-weight: bold;
            margin-left: 5px;
        }

        .bb-code-container {
            width: 100%;
            margin-top: 15px;
        }

        #ratingBBCode {
            width: 100%;
            height: 150px;
            background: rgba(21, 39, 63, 0.8);
            color: white;
            border: 1px solid #8A6A3E;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
        }

        .copy-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 8px 15px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        .copy-btn:hover {
            background: #6B5A48;
        }

        .category-icon {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 3px;
        }

        .blind-simple-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .blind-simple-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 8px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .blind-simple-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #8A6A3E;
        }

        .blind-simple-table .position {
            width: 50px;
            text-align: center;
            font-weight: bold;
        }

        .blind-simple-table .name {
            text-align: left;
            padding-left: 15px;
        }

        .name-with-icons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }

        .participant-name {
            flex: 1;
        }

        .category-icons-container {
            display: flex;
            gap: 5px;
        }

        .rating-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: #5D4C3A;
            color: #E8D8C0;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #8A6A3E;
            color: white;
        }

        .toggle-btn:hover {
            background: #6B5A48;
        }

        .medium-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .medium-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 8px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .medium-table td {
            padding: 8px;
            border: 1px solid #8A6A3E;
        }

        .medium-table .position {
            width: 50px;
            text-align: center;
            font-weight: bold;
        }

        .medium-table .name {
            text-align: left;
            padding-left: 15px;
        }

        .medium-table .score {
            text-align: center;
        }

        .score-with-icons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .score-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>RAVENCLAW</h1>
        <p class="subtitle">Квест "Гнев Кернунна"</p>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('participants')">Участники</button>
            <button class="tab-btn" onclick="switchTab('tasks')">Задания</button>
            <button class="tab-btn" onclick="switchTab('journal')">Журнал</button>
            <button class="tab-btn" style="margin-left: auto; background: #5a4a4a;" onclick="toggleExportImport()">Экспорт/Импорт</button>
        </div>

        <div id="exportImportPanel" class="export-import-section" style="display: none;">
            <h3 style="color: #C9A86A; margin-bottom: 15px;">Экспорт и импорт данных</h3>
            <button class="add-btn" onclick="exportData()">Экспортировать (JSON)</button>
            <button class="add-btn" onclick="document.getElementById('importFile').click()">Импортировать (JSON)</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            <p style="color: #aaa; margin-top: 10px; font-size: 0.9em;">Экспортируйте данные в файл JSON и импортируйте их на другом компьютере или браузере</p>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>Вид ведущего (баллы)</h2>
                    <div class="anger-display">
                        <div class="anger-stat">
                            <span>Базовый гнев:</span>
                            <span id="baseAnger">468</span>
                        </div>
                        <div class="anger-stat">
                            <span>Количество участников:</span>
                            <span id="participantCount">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Гнев от участников (×78):</span>
                            <span id="participantAnger">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Гнев Кернунна:</span>
                            <span id="initialAnger" style="color: #B22222; font-size: 1.2em;">468</span>
                        </div>
                        <div style="border-top: 2px solid rgba(255, 255, 255, 0.2); margin: 10px 0;"></div>
                        <div class="anger-stat">
                            <span>Суммарная милость:</span>
                            <span id="totalMercy" style="color: #6B8E23;">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Оставшийся гнев:</span>
                            <span id="currentAnger" class="anger-value high">468</span>
                        </div>
                    </div>
                    <div class="anger-bar">
                        <div id="mercyFillLeader" class="anger-fill" style="width: 0%;">0 / 468</div>
                    </div>

                    <h3 style="margin-top: 20px; color: #C9A86A;">Диаграмма (баллы)</h3>
                    <div class="chart-container">
                        <div class="chart-bar">
                            <div class="chart-label">Базовый гнев</div>
                            <div class="chart-bar-visual anger" id="chartBaseAnger" style="width: 150px;">468</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">Гнев участников</div>
                            <div class="chart-bar-visual anger" id="chartParticipantAnger" style="width: 0px;">0</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">Милость</div>
                            <div class="chart-bar-visual mercy" id="chartMercy" style="width: 0px;">0</div>
                        </div>
                        <div class="chart-bar" style="margin-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 15px;">
                            <div class="chart-label">Оставшийся гнев</div>
                            <div class="chart-bar-visual anger" id="chartCurrentAnger" style="width: 150px;">468</div>
                        </div>
                    </div>
                </div>

                <div class="card purple">
                    <h2>Рейтинг участников</h2>
                    <div class="participant-view-container">
                        <div id="participantAngerContainer">
                            <div class="anger-bar-participant">
                                <div id="mercyFillParticipant" class="mercy-fill-participant" style="width: 0%;">
                                    <span id="mercyPercent">0%</span>
                                </div>
                            </div>
                        </div>
                        <button class="screenshot-btn" onclick="captureAngerBar()">Сохранить шкалу как PNG</button>
                        
                        <div class="rating-container">
                            <h3 style="color: #C9A86A; text-align: center; margin-bottom: 15px;">Таблица рейтинга</h3>
                            
                            <div class="rating-toggle">
                                <button class="toggle-btn active" onclick="switchRatingType('blind')">Слепой рейтинг</button>
                                <button class="toggle-btn" onclick="switchRatingType('medium')">Средний рейтинг</button>
                                <button class="toggle-btn" onclick="switchRatingType('detailed')">Детальный рейтинг</button>
                            </div>
                            
                            <!-- Слепой рейтинг -->
                            <div id="blindRating" class="rating-table-container">
                                <table class="blind-simple-table">
                                    <thead>
                                        <tr>
                                            <th class="position" style="width: 60px;">#</th>
                                            <th class="name">Участник</th>
                                        </tr>
                                    </thead>
                                    <tbody id="blindRatingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Средний рейтинг -->
                            <div id="mediumRating" class="rating-table-container" style="display: none;">
                                <table class="medium-table">
                                    <thead>
                                        <tr>
                                            <th class="position" style="width: 60px;">#</th>
                                            <th class="name">Участник</th>
                                            <th class="score">Общий счет</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mediumRatingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Детальный рейтинг -->
                            <div id="detailedRating" class="rating-table-container" style="display: none;">
                                <table class="rating-table" id="ratingTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">#</th>
                                            <th style="width: 150px;">Участник</th>
                                            <th style="width: 100px;">Общий счёт</th>
                                            <th style="width: 100px;">Зов Друида</th>
                                            <th style="width: 120px;">Тропа Рогатого Бога</th>
                                            <th style="width: 100px;">Пир теней</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ratingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="bb-code-container">
                                <h4 style="color: #C9A86A; margin-bottom: 10px;">BB-код для форума:</h4>
                                <textarea id="ratingBBCode" readonly></textarea>
                                <button class="copy-btn" onclick="copyBBCode()">Копировать BB-код</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participants" class="tab-content">
            <div class="card purple">
                <h2>Список участников</h2>
                <div class="input-group">
                    <input type="text" id="newParticipantName" placeholder="Имя нового участника...">
                    <button class="add-btn" onclick="addParticipant()">Добавить</button>
                </div>
                <ul class="item-list" id="participantsList"></ul>
            </div>
        </div>

        <div id="tasks" class="tab-content">
            <div class="card">
                <h2>Список заданий</h2>
                <div class="grid-2">
                    <input type="text" id="newTaskName" placeholder="Название задания...">
                    <input type="number" id="newTaskMercy" placeholder="Очки милости..." min="1">
                </div>
                <button class="add-btn" onclick="addTask()">Добавить задание</button>
                <ul class="item-list" id="tasksList"></ul>
            </div>
        </div>

        <div id="journal" class="tab-content">
            <div class="card green">
                <h2>Журнал выполненных заданий</h2>
                <div class="grid-2">
                    <div>
                        <label style="font-size: 0.9em; color: #aaa;">Выберите участника:</label>
                        <select id="journalParticipant"></select>
                    </div>
                    <div>
                        <label style="font-size: 0.9em; color: #aaa;">Выберите задание:</label>
                        <select id="journalTask"></select>
                    </div>
                </div>
                <button class="add-btn" onclick="addJournalEntry()" style="background: #6B8E23;">Добавить запись</button>

                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Участник</th>
                            <th>Задание</th>
                            <th>Очки милости</th>
                            <th>Действие</th>
                        </tr>
                    </thead>
                    <tbody id="journalTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Категории заданий - ОБНОВЛЕННЫЕ ССЫЛКИ
        const categories = {
            'druid': {
                name: 'Зов Друида',
                icon: 'https://ulashyl.github.io/quest/static/media/category1.5f2095aaa5bb86bb3580.png'
            },
            'horned': {
                name: 'Тропа Рогатого Бога', 
                icon: 'https://ulashyl.github.io/quest/static/media/category3.013889044053f209aac6.png'
            },
            'shadows': {
                name: 'Пир теней',
                icon: 'https://ulashyl.github.io/quest/static/media/category2.061ef8c50536e607b8ff.png'
            }
        };

        // Стандартные задания по категориям
        const defaultTasks = [
            // Зов Друида
            { id: 1, name: 'Зов Друида (легкое)', mercy: 2, category: 'druid' },
            { id: 2, name: 'Зов Друида (среднее)', mercy: 4, category: 'druid' },
            { id: 3, name: 'Зов Друида (сложное)', mercy: 6, category: 'druid' },
            
            // Тропа Рогатого Бога
            { id: 4, name: 'Тропа Рогатого Бога (легкое)', mercy: 2, category: 'horned' },
            { id: 5, name: 'Тропа Рогатого Бога (среднее)', mercy: 4, category: 'horned' },
            { id: 6, name: 'Тропа Рогатого Бога (сложное)', mercy: 6, category: 'horned' },
            
            // Пир теней
            { id: 7, name: 'Пир теней (легкое)', mercy: 2, category: 'shadows' },
            { id: 8, name: 'Пир теней (среднее)', mercy: 4, category: 'shadows' },
            { id: 9, name: 'Пир теней (сложное)', mercy: 6, category: 'shadows' }
        ];

        // Текущий тип рейтинга
        let currentRatingType = 'blind';

        function switchRatingType(type) {
            currentRatingType = type;
            
            // Обновляем активные кнопки
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            if (type === 'blind') {
                document.querySelector('.toggle-btn:nth-child(1)').classList.add('active');
                document.getElementById('blindRating').style.display = 'block';
                document.getElementById('mediumRating').style.display = 'none';
                document.getElementById('detailedRating').style.display = 'none';
            } else if (type === 'medium') {
                document.querySelector('.toggle-btn:nth-child(2)').classList.add('active');
                document.getElementById('blindRating').style.display = 'none';
                document.getElementById('mediumRating').style.display = 'block';
                document.getElementById('detailedRating').style.display = 'none';
            } else {
                document.querySelector('.toggle-btn:nth-child(3)').classList.add('active');
                document.getElementById('blindRating').style.display = 'none';
                document.getElementById('mediumRating').style.display = 'none';
                document.getElementById('detailedRating').style.display = 'block';
            }
            
            // Обновляем BB-код в зависимости от типа
            updateRatingTable();
        }

        function saveData() {
            const data = { participants, tasks, journal };
            localStorage.setItem('questData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('questData');
            if (saved) {
                const data = JSON.parse(saved);
                participants = data.participants || participants;
                tasks = data.tasks || tasks;
                journal = data.journal || journal;
                
                // Если задач нет, добавляем стандартные
                if (tasks.length === 0) {
                    tasks = [...defaultTasks];
                }
            } else {
                // При первом запуске добавляем стандартные задания
                tasks = [...defaultTasks];
            }
        }

        function exportData() {
            const data = {
                participants,
                tasks,
                journal,
                exportDate: new Date().toLocaleString('ru-RU')
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quest_samaina_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('Данные экспортированы!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.participants && data.tasks && data.journal) {
                        participants = data.participants;
                        tasks = data.tasks;
                        journal = data.journal;
                        saveData();
                        renderParticipants();
                        renderTasks();
                        renderJournal();
                        updateRatingTable();
                        alert('Данные импортированы успешно!');
                    } else {
                        alert('Неверный формат файла');
                    }
                } catch (error) {
                    alert('Ошибка при импорте: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function toggleExportImport() {
            const panel = document.getElementById('exportImportPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function captureAngerBar() {
            const angerBarContainer = document.getElementById('participantAngerContainer');
            const angerBar = angerBarContainer.querySelector('.anger-bar-participant');
            const percent = document.getElementById('mercyPercent').textContent;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Размеры шкалы
                const barWidth = 600;
                const barHeight = 80;
                const padding = 20;
                
                canvas.width = barWidth + padding * 2;
                canvas.height = barHeight + padding * 2;
                
                // Прозрачный фон
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Координаты шкалы
                const x = padding;
                const y = padding;
                
                // Градиент фона шкалы (гнев)
                const gradient = ctx.createLinearGradient(x, y, x + barWidth, y);
                gradient.addColorStop(0, '#8B4513');
                gradient.addColorStop(0.5, '#A0522D');
                gradient.addColorStop(1, '#CD5C5C');
                
                // Рисуем фоновую шкалу (гнев)
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, 15);
                ctx.fill();
                
                // Рисуем заполняющую часть (милость)
                const percentValue = parseInt(percent);
                const fillWidth = (barWidth * percentValue) / 100;
                
                // Градиент милости
                const mercyGradient = ctx.createLinearGradient(x, y, x + barWidth, y);
                mercyGradient.addColorStop(0, '#556B2F');
                mercyGradient.addColorStop(0.5, '#6B8E23');
                mercyGradient.addColorStop(1, '#8FBC8F');
                
                ctx.fillStyle = mercyGradient;
                ctx.beginPath();
                ctx.roundRect(x, y, fillWidth, barHeight, 15);
                ctx.fill();
                
                // Рисуем текст с процентом
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px "Sofia Sans Extra Condensed"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 6;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.fillText(percent, canvas.width / 2, canvas.height / 2);
                
                // Сохраняем как PNG
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `anger_scale_${new Date().toISOString().split('T')[0]}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    alert('Шкала сохранена как PNG!');
                }, 'image/png');
            } catch (error) {
                alert('Ошибка при сохранении: ' + error.message);
            }
        }

        function clearAllData() {
            if (confirm('Вы уверены? Все данные будут удалены навсегда!')) {
                localStorage.removeItem('questData');
                participants = [];
                tasks = [...defaultTasks];
                journal = [];
                renderParticipants();
                renderTasks();
                renderJournal();
                updateRatingTable();
                alert('Данные восстановлены к начальному состоянию');
            }
        }

        let participants = [];
        let tasks = [];
        let journal = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function updateDashboard() {
            const baseAnger = 468;
            const participantCount = participants.length;
            const participantAnger = participantCount * 78; // 78 за каждого участника
            const initialAnger = baseAnger + participantAnger;
            const totalMercy = journal.reduce((sum, entry) => sum + entry.mercy, 0);
            const currentAnger = Math.max(0, initialAnger - totalMercy);
            const mercyPercent = initialAnger === 0 ? 0 : Math.round((totalMercy / initialAnger) * 100);

            document.getElementById('baseAnger').textContent = baseAnger;
            document.getElementById('participantCount').textContent = participantCount;
            document.getElementById('participantAnger').textContent = participantAnger;
            document.getElementById('initialAnger').textContent = initialAnger;
            document.getElementById('totalMercy').textContent = totalMercy;
            document.getElementById('currentAnger').textContent = currentAnger;

            // Шкала ведущего: зеленая милость растет слева направо
            const mercyFillLeader = document.getElementById('mercyFillLeader');
            mercyFillLeader.style.width = mercyPercent + '%';
            mercyFillLeader.textContent = totalMercy + ' / ' + initialAnger;

            // Шкала участника: зеленая милость растет слева направо
            document.getElementById('mercyPercent').textContent = mercyPercent + '%';
            const mercyFillParticipant = document.getElementById('mercyFillParticipant');
            mercyFillParticipant.style.width = mercyPercent + '%';

            const angerValue = document.getElementById('currentAnger');
            angerValue.className = 'anger-value';
            if (currentAnger > initialAnger * 0.67) {
                angerValue.classList.add('high');
            } else if (currentAnger > initialAnger * 0.33) {
                angerValue.classList.add('medium');
            } else {
                angerValue.classList.add('low');
            }

            // Обновляем диаграммы с пропорциональным отображением
            const maxWidth = 300; // Максимальная ширина для диаграмм
            
            // Базовый гнев (468) - всегда отображается как фиксированная часть
            document.getElementById('chartBaseAnger').style.width = (baseAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartBaseAnger').textContent = baseAnger;
            
            // Гнев участников
            document.getElementById('chartParticipantAnger').style.width = (participantAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartParticipantAnger').textContent = participantAnger;
            
            // Милость
            document.getElementById('chartMercy').style.width = (totalMercy / initialAnger * maxWidth) + 'px';
            document.getElementById('chartMercy').textContent = totalMercy;
            
            // Оставшийся гнев
            document.getElementById('chartCurrentAnger').style.width = (currentAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartCurrentAnger').textContent = currentAnger;
        }

        function updateRatingTable() {
            // Собираем статистику по участникам
            const participantStats = {};
            
            participants.forEach(participant => {
                participantStats[participant.id] = {
                    name: participant.name,
                    total: 0,
                    byCategory: {
                        'druid': 0,
                        'horned': 0,
                        'shadows': 0
                    }
                };
            });
            
            // Заполняем статистику из журнала
            journal.forEach(entry => {
                const participant = participantStats[entry.participantId];
                const task = tasks.find(t => t.id === entry.taskId);
                
                if (participant && task) {
                    participant.total += entry.mercy;
                    
                    if (task.category && participant.byCategory[task.category] !== undefined) {
                        participant.byCategory[task.category] += entry.mercy;
                    }
                }
            });
            
            // Находим лидеров в каждой категории
            const categoryLeaders = {
                'druid': { score: 0, participants: [] },
                'horned': { score: 0, participants: [] },
                'shadows': { score: 0, participants: [] }
            };
            
            Object.values(participantStats).forEach(stat => {
                Object.keys(categoryLeaders).forEach(category => {
                    if (stat.byCategory[category] > categoryLeaders[category].score) {
                        categoryLeaders[category].score = stat.byCategory[category];
                        categoryLeaders[category].participants = [stat.name];
                    } else if (stat.byCategory[category] === categoryLeaders[category].score && stat.byCategory[category] > 0) {
                        categoryLeaders[category].participants.push(stat.name);
                    }
                });
            });
            
            // Сортируем участников по общему счету
            const sortedStats = Object.values(participantStats).sort((a, b) => b.total - a.total);
            
            // Обновляем слепой рейтинг
            updateBlindRating(sortedStats, categoryLeaders);
            
            // Обновляем средний рейтинг
            updateMediumRating(sortedStats, categoryLeaders);
            
            // Обновляем детальный рейтинг
            updateDetailedRating(sortedStats, categoryLeaders);
            
            // Генерируем BB-код в зависимости от текущего типа
            generateBBCode(sortedStats, categoryLeaders);
        }

        function updateBlindRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('blindRatingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем, в каких категориях участник является лидером
                const leaderCategories = [];
                if (categoryLeaders.druid.participants.includes(stat.name)) {
                    leaderCategories.push('druid');
                }
                if (categoryLeaders.horned.participants.includes(stat.name)) {
                    leaderCategories.push('horned');
                }
                if (categoryLeaders.shadows.participants.includes(stat.name)) {
                    leaderCategories.push('shadows');
                }
                
                // Создаем HTML для значков категорий
                const categoryIconsHtml = leaderCategories.map(cat => 
                    `<img src="${categories[cat].icon}" alt="${categories[cat].name}" class="category-icon">`
                ).join('');
                
                return `
                    <tr>
                        <td class="position">${position}</td>
                        <td class="name">
                            <div class="name-with-icons">
                                <span class="participant-name">${stat.name}</span>
                                <div class="category-icons-container">
                                    ${categoryIconsHtml}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateMediumRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('mediumRatingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем, в каких категориях участник является лидером
                const leaderCategories = [];
                if (categoryLeaders.druid.participants.includes(stat.name)) {
                    leaderCategories.push('druid');
                }
                if (categoryLeaders.horned.participants.includes(stat.name)) {
                    leaderCategories.push('horned');
                }
                if (categoryLeaders.shadows.participants.includes(stat.name)) {
                    leaderCategories.push('shadows');
                }
                
                // Создаем HTML для значков категорий
                const categoryIconsHtml = leaderCategories.map(cat => 
                    `<img src="${categories[cat].icon}" alt="${categories[cat].name}" class="category-icon">`
                ).join('');
                
                return `
                    <tr>
                        <td class="position">${position}</td>
                        <td class="name">${stat.name}</td>
                        <td class="score">
                            <div class="score-with-icons">
                                <span class="score-value">${stat.total}</span>
                                ${categoryIconsHtml}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDetailedRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('ratingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем лидеров для каждой категории
                const isDruidLeader = categoryLeaders.druid.participants.includes(stat.name);
                const isHornedLeader = categoryLeaders.horned.participants.includes(stat.name);
                const isShadowsLeader = categoryLeaders.shadows.participants.includes(stat.name);
                
                return `
                    <tr>
                        <td>${position}</td>
                        <td>${stat.name}</td>
                        <td><strong>${stat.total}</strong></td>
                        <td>${stat.byCategory.druid} ${isDruidLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                        <td>${stat.byCategory.horned} ${isHornedLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                        <td>${stat.byCategory.shadows} ${isShadowsLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateBBCode(sortedStats, categoryLeaders) {
            const bbCodeTextarea = document.getElementById('ratingBBCode');
            
            if (currentRatingType === 'blind') {
                // BB-код для слепого рейтинга
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=250][b]Участник[/b][/width][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем, в каких категориях участник является лидером
                    const leaderCategories = [];
                    if (categoryLeaders.druid.participants.includes(stat.name)) {
                        leaderCategories.push('druid');
                    }
                    if (categoryLeaders.horned.participants.includes(stat.name)) {
                        leaderCategories.push('horned');
                    }
                    if (categoryLeaders.shadows.participants.includes(stat.name)) {
                        leaderCategories.push('shadows');
                    }
                    
                    // Создаем BB-код для значков категорий
                    const categoryIconsBb = leaderCategories.map(cat => 
                        ` [img]${categories[cat].icon}[/img]`
                    ).join('');
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=250]${stat.name}${categoryIconsBb}[/width][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            } else if (currentRatingType === 'medium') {
                // BB-код для среднего рейтинга - ИСПРАВЛЕНО ЦЕНТРИРОВАНИЕ
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=250][b]Участник[/b][/width][/td][td][center][width=100][b]Общий счет[/b][/width][/center][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем, в каких категориях участник является лидером
                    const leaderCategories = [];
                    if (categoryLeaders.druid.participants.includes(stat.name)) {
                        leaderCategories.push('druid');
                    }
                    if (categoryLeaders.horned.participants.includes(stat.name)) {
                        leaderCategories.push('horned');
                    }
                    if (categoryLeaders.shadows.participants.includes(stat.name)) {
                        leaderCategories.push('shadows');
                    }
                    
                    // Создаем BB-код для значков категорий
                    const categoryIconsBb = leaderCategories.map(cat => 
                        ` [img]${categories[cat].icon}[/img]`
                    ).join('');
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=250]${stat.name}[/width][/td][td][center][width=100]${stat.total}${categoryIconsBb}[/center][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            } else {
                // BB-код для детального рейтинга
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=150][b]Участник[/b][/width][/td][td][center][width=100][b]Общий счет[/b][/width][/center][/td]
[td][center][width=30][img]${categories.druid.icon}[/img][/width][/center][/td]
[td][center][width=30][img]${categories.horned.icon}[/img][/width][/center][/td]
[td][center][width=30][img]${categories.shadows.icon}[/img][/width][/center][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем лидеров для каждой категории
                    const isDruidLeader = categoryLeaders.druid.participants.includes(stat.name);
                    const isHornedLeader = categoryLeaders.horned.participants.includes(stat.name);
                    const isShadowsLeader = categoryLeaders.shadows.participants.includes(stat.name);
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=150]${stat.name}[/width][/td]
[td][width=100][center]${stat.total}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.druid}${isDruidLeader ? ' ★' : ''}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.horned}${isHornedLeader ? ' ★' : ''}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.shadows}${isShadowsLeader ? ' ★' : ''}[/center][/width][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            }
        }

        function copyBBCode() {
            const bbCodeTextarea = document.getElementById('ratingBBCode');
            bbCodeTextarea.select();
            document.execCommand('copy');
            alert('BB-код скопирован в буфер обмена!');
        }

        function renderParticipants() {
            const list = document.getElementById('participantsList');
            list.innerHTML = participants.map(p => `
                <li class="purple-item">
                    <span><strong>#${p.id}</strong> ${p.name}</span>
                    <button class="delete-btn" onclick="deleteParticipant(${p.id})">Удалить</button>
                </li>
            `).join('');

            updateParticipantSelect();
            updateDashboard(); // Обновляем dashboard при изменении участников
            updateRatingTable();
        }

        function renderTasks() {
            const list = document.getElementById('tasksList');
            list.innerHTML = tasks.map(t => {
                const category = categories[t.category];
                const iconHtml = category ? `<img src="${category.icon}" alt="${category.name}" class="category-icon">` : '';
                const categoryName = category ? category.name : 'Без категории';
                
                return `
                <li>
                    <span>${iconHtml} <strong>#${t.id}</strong> ${t.name} <span style="color: #6B8E23; margin-left: 10px;">Милость: +${t.mercy}</span> <span style="color: #aaa; font-size: 0.9em;">(${categoryName})</span></span>
                    <button class="delete-btn" onclick="deleteTask(${t.id})">Удалить</button>
                </li>
            `}).join('');

            updateTaskSelect();
        }

        function renderJournal() {
            const table = document.getElementById('journalTable');
            table.innerHTML = journal.map(j => {
                const participant = participants.find(p => p.id === j.participantId);
                const task = tasks.find(t => t.id === j.taskId);
                const category = task && categories[task.category];
                const iconHtml = category ? `<img src="${category.icon}" alt="${category.name}" class="category-icon">` : '';
                
                return `
                    <tr>
                        <td>${j.date}</td>
                        <td>${participant ? participant.name : 'Неизвестно'}</td>
                        <td>${iconHtml} ${task ? task.name : 'Неизвестно'}</td>
                        <td style="text-align: center; color: #6B8E23;">+${j.mercy}</td>
                        <td style="text-align: center;">
                            <button class="delete-btn" onclick="deleteJournalEntry(${j.id})">Удалить</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateDashboard();
            updateRatingTable();
        }

        function updateParticipantSelect() {
            const select = document.getElementById('journalParticipant');
            select.innerHTML = '<option value="">Выберите участника...</option>' + 
                participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function updateTaskSelect() {
            const select = document.getElementById('journalTask');
            select.innerHTML = '<option value="">Выберите задание...</option>' + 
                tasks.map(t => {
                    const category = categories[t.category];
                    const categoryName = category ? category.name : 'Без категории';
                    return `<option value="${t.id}">${t.name} (+${t.mercy}) - ${categoryName}</option>`;
                }).join('');
        }

        function addParticipant() {
            const name = document.getElementById('newParticipantName').value.trim();
            if (name) {
                const id = participants.length > 0 ? Math.max(...participants.map(p => p.id)) + 1 : 1;
                participants.push({ id, name });
                document.getElementById('newParticipantName').value = '';
                renderParticipants();
                saveData();
            }
        }

        function deleteParticipant(id) {
            participants = participants.filter(p => p.id !== id);
            journal = journal.filter(j => j.participantId !== id);
            renderParticipants();
            renderJournal();
            saveData();
        }

        function addTask() {
            const name = document.getElementById('newTaskName').value.trim();
            const mercy = parseInt(document.getElementById('newTaskMercy').value) || 0;
            if (name && mercy > 0) {
                const id = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                tasks.push({ id, name, mercy });
                document.getElementById('newTaskName').value = '';
                document.getElementById('newTaskMercy').value = '';
                renderTasks();
                saveData();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            saveData();
        }

        function addJournalEntry() {
            const participantId = parseInt(document.getElementById('journalParticipant').value);
            const taskId = parseInt(document.getElementById('journalTask').value);
            
            if (participantId && taskId) {
                const task = tasks.find(t => t.id === taskId);
                const id = journal.length > 0 ? Math.max(...journal.map(j => j.id)) + 1 : 1;
                const today = new Date().toISOString().split('T')[0];
                journal.push({
                    id,
                    date: today,
                    participantId,
                    taskId,
                    mercy: task.mercy
                });
                document.getElementById('journalParticipant').value = '';
                document.getElementById('journalTask').value = '';
                renderJournal();
                saveData();
            }
        }

        function deleteJournalEntry(id) {
            journal = journal.filter(j => j.id !== id);
            renderJournal();
            saveData();
        }

        window.addEventListener('load', () => {
            loadData();
            renderParticipants();
            renderTasks();
            renderJournal();
            // Устанавливаем слепой рейтинг по умолчанию
            switchRatingType('blind');
        });
    </script>
</body>
</html>
