<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ravenclaw - Квест "Гнев Кернунна"</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sofia+Sans+Extra+Condensed:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            background: url('https://radika1.link/2025/08/01/ra_forum_background_img_08c2550a6ef5a7985.jpg') center center fixed;
            background-size: auto;
            background-repeat: repeat;
            min-height: 100vh;
            color: #fff;
            font-size: 18px;
        }

        header {
            background: rgba(0, 0, 0, 0.8) url('https://radika1.link/2025/08/01/ra_forum_background_img_08c2550a6ef5a7985.jpg') center center;
            background-size: auto;
            background-repeat: repeat;
            border-bottom: 0px double #8A6A3E;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header::before {
            display: none; 
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
        }

        header > * {
            position: relative;
            z-index: 2;
        }

        h1 {
            font-family: 'Permanent Marker', cursive;
            font-size: 2.8em;
            color: #8A6A3E;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            color: #C9A86A;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .container {
            max-width: 1400px;
            margin: 15px auto;
            padding: 0 15px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: rgba(21, 39, 63, 0.9);
            padding: 8px;
            border-radius: 6px;
            border: 2px double #8A6A3E;
        }

        button.tab-btn {
            padding: 10px 16px;
            background: #5D4C3A;
            color: #E8D8C0;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        button.tab-btn:hover {
            background: #6B5A48;
            transform: translateY(-1px);
        }

        button.tab-btn.active {
            background: #8A6A3E;
            color: #fff;
            border-color: #5D4C3A;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(21, 39, 63, 0.95);
            border: 2px double #8A6A3E;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card.purple {
            border-color: #8A6A3E;
        }

        .card.green {
            border-color: #8A6A3E;
        }

        h2 {
            color: #C9A86A;
            margin-bottom: 12px;
            font-size: 1.6em;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-weight: 600;
        }

        .card.purple h2 {
            color: #C9A86A;
        }

        .card.green h2 {
            color: #C9A86A;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            background: rgba(21, 39, 63, 0.8);
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            color: #fff;
            font-size: 0.95em;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder {
            color: #999;
        }

        button.add-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 8px 16px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 8px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-size: 1em;
        }

        button.add-btn:hover {
            background: #6B5A48;
            transform: scale(1.03);
        }

        button.delete-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 5px 10px;
            border: 1px solid #8A6A3E;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        button.delete-btn:hover {
            background: #6B5A48;
        }

        .item-list {
            list-style: none;
        }

        .item-list li {
            background: rgba(21, 39, 63, 0.6);
            padding: 10px;
            margin: 6px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #8A6A3E;
        }

        .item-list li.purple-item {
            border-left-color: #8A6A3E;
        }

        .item-list li.green-item {
            border-left-color: #8A6A3E;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th {
            background: #15273F;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #8A6A3E;
            color: #C9A86A;
            font-weight: 600;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        .card.green th {
            border-bottom-color: #8A6A3E;
            color: #C9A86A;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #8A6A3E;
            background: #15273F;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        tr:hover {
            background: rgba(138, 106, 62, 0.2);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .anger-display {
            background: rgba(21, 39, 63, 0.8);
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #8A6A3E;
        }

        .anger-stat {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 1em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .anger-stat:last-child {
            border-bottom: none;
        }

        .anger-stat span:last-child {
            font-weight: bold;
            color: #C9A86A;
        }

        .card.purple .anger-stat span:last-child {
            color: #C9A86A;
        }

        .card.green .anger-stat span:last-child {
            color: #C9A86A;
        }

        .anger-value {
            font-size: 1.2em !important;
            color: #B22222 !important;
        }

        .anger-value.high {
            color: #B22222 !important;
        }

        .anger-value.medium {
            color: #CD5C5C !important;
        }

        .anger-value.low {
            color: #6B8E23 !important;
        }

        .anger-bar {
            width: 100%;
            height: 25px;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #CD5C5C 100%);
            border-radius: 12px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .anger-fill {
            height: 100%;
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 50%, #8FBC8F 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            position: absolute;
            right: 0;
            font-size: 0.9em;
        }

        .chart-container {
            background: rgba(21, 39, 63, 0.6);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            border: 1px solid #8A6A3E;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 8px;
        }

        .chart-label {
            min-width: 120px;
            text-align: right;
            font-size: 0.9em;
        }

        .chart-bar-visual {
            flex: 1;
            height: 20px;
            background: linear-gradient(90deg, #5D4C3A 0%, #8A6A3E 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .chart-bar-visual.mercy {
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 100%);
        }

        .chart-bar-visual.anger {
            background: linear-gradient(90deg, #8B4513 0%, #CD5C5C 100%);
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        @media (max-width: 768px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .status-badge.rage {
            background: #B22222;
            color: white;
        }

        .status-badge.growing {
            background: #CD5C5C;
            color: white;
        }

        .status-badge.calming {
            background: #8A6A3E;
            color: white;
        }

        .status-badge.peaceful {
            background: #6B8E23;
            color: white;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        .input-group input,
        .input-group select {
            margin: 0;
        }

        .input-group input {
            flex: 1;
        }

        .export-import-section {
            background: rgba(21, 39, 63, 0.8);
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border: 2px double #8A6A3E;
        }

        .export-import-section button {
            margin: 4px;
        }

        #importFile {
            display: none;
        }

        .participant-view-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #participantAngerContainer {
            width: 100%;
            max-width: 500px;
        }

        .anger-bar-participant {
            width: 100%;
            height: 40px;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 35%, #CD5C5C 65%, #D2691E 100%);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 12px;
            position: relative;
            border: 2px solid #8A6A3E;
        }

        .mercy-fill-participant {
            height: 100%;
            background: linear-gradient(90deg, #556B2F 0%, #6B8E23 50%, #8FBC8F 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
        }

        .mercy-fill-participant span {
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 10;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .screenshot-btn {
            background: linear-gradient(135deg, #5D4C3A 0%, #8A6A3E 100%);
            color: #E8D8C0;
            padding: 10px 20px;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s;
            margin-top: 15px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
        }

        .screenshot-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(93, 76, 58, 0.6);
        }

        .rating-container {
            width: 100%;
            max-width: 500px;
            background: rgba(21, 39, 63, 0.8);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #8A6A3E;
            margin-top: 15px;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .rating-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 6px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .rating-table td {
            padding: 6px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .leader-badge {
            color: #FFD700;
            font-weight: bold;
            margin-left: 3px;
        }

        .bb-code-container {
            width: 100%;
            margin-top: 12px;
        }

        #ratingBBCode {
            width: 100%;
            height: 120px;
            background: rgba(21, 39, 63, 0.8);
            color: white;
            border: 1px solid #8A6A3E;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            resize: vertical;
            font-size: 0.9em;
        }

        .copy-btn {
            background: #5D4C3A;
            color: #E8D8C0;
            padding: 6px 12px;
            border: 1px solid #8A6A3E;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 8px;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            font-size: 0.9em;
        }

        .copy-btn:hover {
            background: #6B5A48;
        }

        .category-icon {
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-right: 2px;
        }

        .blind-simple-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .blind-simple-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 6px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .blind-simple-table td {
            padding: 6px;
            text-align: left;
            border: 1px solid #8A6A3E;
        }

        .blind-simple-table .position {
            width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .blind-simple-table .name {
            text-align: left;
            padding-left: 10px;
        }

        .name-with-icons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
        }

        .participant-name {
            flex: 1;
        }

        .category-icons-container {
            display: flex;
            gap: 3px;
        }

        .rating-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            background: #5D4C3A;
            color: #E8D8C0;
            border: 1px solid #8A6A3E;
            border-radius: 3px;
            cursor: pointer;
            font-family: "Sofia Sans Extra Condensed", sans-serif;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .toggle-btn.active {
            background: #8A6A3E;
            color: white;
        }

        .toggle-btn:hover {
            background: #6B5A48;
        }

        .medium-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .medium-table th {
            background: rgba(138, 106, 62, 0.3);
            padding: 6px;
            text-align: center;
            border: 1px solid #8A6A3E;
        }

        .medium-table td {
            padding: 6px;
            border: 1px solid #8A6A3E;
        }

        .medium-table .position {
            width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .medium-table .name {
            text-align: left;
            padding-left: 10px;
        }

        .medium-table .score {
            text-align: center;
        }

        .score-with-icons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .score-value {
            font-weight: bold;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        .task-category {
            margin-bottom: 15px;
        }

        .task-category h3 {
            color: #C9A86A;
            margin-bottom: 8px;
            padding-bottom: 3px;
            border-bottom: 1px solid #8A6A3E;
            font-size: 1.2em;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: rgba(21, 39, 63, 0.6);
            border-radius: 4px;
            margin-bottom: 4px;
            border-left: 3px solid #8A6A3E;
        }

        .task-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
        }

        .task-mercy-input {
            width: 50px;
            padding: 4px;
            background: rgba(21, 39, 63, 0.8);
            border: 1px solid #8A6A3E;
            border-radius: 3px;
            color: white;
            text-align: center;
            font-size: 0.9em;
        }

        /* КОМПАКТНОЕ ПОЛЕ ДАТЫ В ЖУРНАЛЕ */
        .date-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .date-selector label {
            color: #C9A86A;
            font-weight: bold;
            min-width: 50px;
        }

        .date-selector input {
            width: 150px;
        }

        .participant-selector {
            margin-bottom: 15px;
        }

        .tasks-container {
            display: none;
        }

        .tasks-container.active {
            display: block;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ КОМПАКТНОГО ЖУРНАЛА */
        .journal-categories {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        @media (max-width: 1024px) {
            .journal-categories {
                grid-template-columns: 1fr;
            }
        }

        .journal-category {
            background: rgba(21, 39, 63, 0.7);
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #8A6A3E;
        }

        .journal-category h3 {
            color: #C9A86A;
            margin-bottom: 8px;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 1px solid #8A6A3E;
            padding-bottom: 5px;
        }

        /* ОБНОВЛЕННЫЕ СТИЛИ ДЛЯ УЧАСТНИКОВ В ТРИ СТОЛБЦА */
        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        @media (max-width: 1024px) {
            .participants-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .participants-grid {
                grid-template-columns: 1fr;
            }
        }

        .participant-card {
            background: rgba(21, 39, 63, 0.6);
            border-radius: 5px;
            padding: 10px;
            border-left: 3px solid #8A6A3E;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .participant-date {
            font-size: 0.8em;
            color: #aaa;
        }

        .participant-actions {
            display: flex;
            gap: 5px;
        }

        .compact-btn {
            padding: 4px 8px;
            font-size: 0.8em;
        }

        /* СТИЛЬ ДЛЯ СООБЩЕНИЯ О НАЧАЛЕ КВЕСТА */
        .started-later-message {
            background: rgba(193, 66, 66, 0.3);
            border: 1px solid #B22222;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
            color: #E8D8C0;
        }
    </style>
</head>
<body>
    <header>
        <h1>RAVENCLAW</h1>
        <p class="subtitle">Квест "Гнев Кернунна"</p>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('participants')">Участники</button>
            <button class="tab-btn" onclick="switchTab('journal')">Журнал</button>
            <button class="tab-btn" style="margin-left: auto; background: #5a4a4a;" onclick="toggleExportImport()">Экспорт/Импорт</button>
        </div>

        <div id="exportImportPanel" class="export-import-section" style="display: none;">
            <h3 style="color: #C9A86A; margin-bottom: 12px; font-size: 1.3em;">Экспорт и импорт данных</h3>
            <button class="add-btn" onclick="exportData()">Экспортировать (JSON)</button>
            <button class="add-btn" onclick="document.getElementById('importFile').click()">Импортировать (JSON)</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            <p style="color: #aaa; margin-top: 8px; font-size: 0.85em;">Экспортируйте данные в файл JSON и импортируйте их на другом компьютере или браузере</p>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>Вид ведущего (баллы)</h2>
                    <div class="anger-display">
                        <div class="anger-stat">
                            <span>Базовый гнев:</span>
                            <span id="baseAnger">468</span>
                        </div>
                        <div class="anger-stat">
                            <span>Количество участников:</span>
                            <span id="participantCount">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Гнев от участников (×78):</span>
                            <span id="participantAnger">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Гнев Кернунна:</span>
                            <span id="initialAnger" style="color: #B22222; font-size: 1.1em;">468</span>
                        </div>
                        <div style="border-top: 2px solid rgba(255, 255, 255, 0.2); margin: 8px 0;"></div>
                        <div class="anger-stat">
                            <span>Суммарная милость:</span>
                            <span id="totalMercy" style="color: #6B8E23;">0</span>
                        </div>
                        <div class="anger-stat">
                            <span>Оставшийся гнев:</span>
                            <span id="currentAnger" class="anger-value high">468</span>
                        </div>
                    </div>
                    <div class="anger-bar">
                        <div id="mercyFillLeader" class="anger-fill" style="width: 0%;">0 / 468</div>
                    </div>

                    <h3 style="margin-top: 15px; color: #C9A86A; font-size: 1.3em;">Диаграмма (баллы)</h3>
                    <div class="chart-container">
                        <div class="chart-bar">
                            <div class="chart-label">Базовый гнев</div>
                            <div class="chart-bar-visual anger" id="chartBaseAnger" style="width: 120px;">468</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">Гнев участников</div>
                            <div class="chart-bar-visual anger" id="chartParticipantAnger" style="width: 0px;">0</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">Милость</div>
                            <div class="chart-bar-visual mercy" id="chartMercy" style="width: 0px;">0</div>
                        </div>
                        <div class="chart-bar" style="margin-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 12px;">
                            <div class="chart-label">Оставшийся гнев</div>
                            <div class="chart-bar-visual anger" id="chartCurrentAnger" style="width: 120px;">468</div>
                        </div>
                    </div>
                </div>

                <div class="card purple">
                    <h2>Рейтинг участников</h2>
                    <div class="participant-view-container">
                        <div id="participantAngerContainer">
                            <div class="anger-bar-participant">
                                <div id="mercyFillParticipant" class="mercy-fill-participant" style="width: 0%;">
                                    <span id="mercyPercent">0%</span>
                                </div>
                            </div>
                        </div>
                        <button class="screenshot-btn" onclick="captureAngerBar()">Сохранить шкалу как PNG</button>
                        
                        <div class="rating-container">
                            <h3 style="color: #C9A86A; text-align: center; margin-bottom: 12px; font-size: 1.3em;">Таблица рейтинга</h3>
                            
                            <div class="rating-toggle">
                                <button class="toggle-btn active" onclick="switchRatingType('blind')">Слепой</button>
                                <button class="toggle-btn" onclick="switchRatingType('medium')">Средний</button>
                                <button class="toggle-btn" onclick="switchRatingType('detailed')">Детальный</button>
                            </div>
                            
                            <!-- Слепой рейтинг -->
                            <div id="blindRating" class="rating-table-container">
                                <table class="blind-simple-table">
                                    <thead>
                                        <tr>
                                            <th class="position" style="width: 50px;">#</th>
                                            <th class="name">Участник</th>
                                        </tr>
                                    </thead>
                                    <tbody id="blindRatingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Средний рейтинг -->
                            <div id="mediumRating" class="rating-table-container" style="display: none;">
                                <table class="medium-table">
                                    <thead>
                                        <tr>
                                            <th class="position" style="width: 50px;">#</th>
                                            <th class="name">Участник</th>
                                            <th class="score">Общий счет</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mediumRatingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Детальный рейтинг -->
                            <div id="detailedRating" class="rating-table-container" style="display: none;">
                                <table class="rating-table" id="ratingTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th style="width: 130px;">Участник</th>
                                            <th style="width: 80px;">Общий счёт</th>
                                            <th style="width: 80px;">Зов Друида</th>
                                            <th style="width: 100px;">Тропа Рогатого Бога</th>
                                            <th style="width: 80px;">Пир теней</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ratingTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="bb-code-container">
                                <h4 style="color: #C9A86A; margin-bottom: 8px; font-size: 1.1em;">BB-код для форума:</h4>
                                <textarea id="ratingBBCode" readonly></textarea>
                                <button class="copy-btn" onclick="copyBBCode()">Копировать BB-код</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participants" class="tab-content">
            <div class="card purple">
                <h2>Список участников</h2>
                <div class="input-group">
                    <input type="text" id="newParticipantName" placeholder="Имя нового участника...">
                    <button class="add-btn" onclick="addParticipant()">Добавить</button>
                </div>
                
                <div class="participants-grid" id="participantsGrid">
                    <!-- Участники будут добавлены динамически -->
                </div>
            </div>
        </div>

        <div id="journal" class="tab-content">
            <div class="card green">
                <h2>Журнал выполненных заданий</h2>
                
                <div class="date-selector">
                    <label for="journalDate">Дата:</label>
                    <input type="date" id="journalDate">
                    <button class="add-btn" onclick="loadJournalForDate()">Загрузить</button>
                </div>
                
                <div class="participant-selector">
                    <label for="journalParticipantSelect">Участник:</label>
                    <select id="journalParticipantSelect" onchange="showTasksForParticipant()">
                        <option value="">Выберите участника...</option>
                    </select>
                </div>
                
                <div id="tasksContainer" class="tasks-container">
                    <!-- Сообщение о начале квеста позже будет добавлено динамически -->
                    <div id="startedLaterMessage" class="started-later-message" style="display: none;"></div>
                    
                    <h3 style="color: #C9A86A; margin-bottom: 12px; font-size: 1.3em;">Задания для выбранного участника</h3>
                    
                    <div class="journal-categories">
                        <div class="journal-category">
                            <h3>Зов Друида</h3>
                            <div id="druidTasks" class="tasks-grid">
                                <!-- Задания будут добавлены динамически -->
                            </div>
                        </div>
                        
                        <div class="journal-category">
                            <h3>Тропа Рогатого Бога</h3>
                            <div id="hornedTasks" class="tasks-grid">
                                <!-- Задания будут добавлены динамически -->
                            </div>
                        </div>
                        
                        <div class="journal-category">
                            <h3>Пир теней</h3>
                            <div id="shadowsTasks" class="tasks-grid">
                                <!-- Задания будут добавлены динамически -->
                            </div>
                        </div>
                    </div>
                    
                    <button class="add-btn" onclick="saveJournalEntries()" style="background: #6B8E23;">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Категории заданий
        const categories = {
            'druid': {
                name: 'Зов Друида',
                icon: 'https://radika1.link/2025/10/30/category1.5f2095aaa5bb86bb3580b05a889722cfa628.png'
            },
            'horned': {
                name: 'Тропа Рогатого Бога', 
                icon: 'https://s2.radikal.cloud/2025/10/30/category3.013889044053f209aac60bc3a4f21ee400ea.png'
            },
            'shadows': {
                name: 'Пир теней',
                icon: 'https://s1.radikal.cloud/2025/10/30/category2.061ef8c50536e607b8ff9ccc8610feac569c.png'
            }
        };

        // Стандартные задания по категориям (УДАЛЕНЫ ШТРАФНЫЕ ЗАДАНИЯ)
        const defaultTasks = [
            // Зов Друида
            { id: 1, name: 'Зов Друида (легкое)', mercy: 2, category: 'druid' },
            { id: 2, name: 'Зов Друида (среднее)', mercy: 4, category: 'druid' },
            { id: 3, name: 'Зов Друида (сложное)', mercy: 6, category: 'druid' },
            
            // Тропа Рогатого Бога (удалены штрафные задания)
            { id: 4, name: 'Тропа Рогатого Бога (легкое)', mercy: 2, category: 'horned' },
            { id: 5, name: 'Тропа Рогатого Бога (среднее)', mercy: 4, category: 'horned' },
            { id: 6, name: 'Тропа Рогатого Бога (сложное)', mercy: 6, category: 'horned' },
            
            // Пир теней (удалены штрафные задания)
            { id: 7, name: 'Пир теней (легкое)', mercy: 2, category: 'shadows' },
            { id: 8, name: 'Пир теней (среднее)', mercy: 4, category: 'shadows' },
            { id: 9, name: 'Пир теней (сложное)', mercy: 6, category: 'shadows' }
        ];

        // Текущий тип рейтинга
        let currentRatingType = 'blind';
        
        // Текущая выбранная дата в журнале
        let currentJournalDate = '';
        
        // Текущий выбранный участник в журнале
        let currentJournalParticipant = null;

        function switchRatingType(type) {
            currentRatingType = type;
            
            // Обновляем активные кнопки
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            if (type === 'blind') {
                document.querySelector('.toggle-btn:nth-child(1)').classList.add('active');
                document.getElementById('blindRating').style.display = 'block';
                document.getElementById('mediumRating').style.display = 'none';
                document.getElementById('detailedRating').style.display = 'none';
            } else if (type === 'medium') {
                document.querySelector('.toggle-btn:nth-child(2)').classList.add('active');
                document.getElementById('blindRating').style.display = 'none';
                document.getElementById('mediumRating').style.display = 'block';
                document.getElementById('detailedRating').style.display = 'none';
            } else {
                document.querySelector('.toggle-btn:nth-child(3)').classList.add('active');
                document.getElementById('blindRating').style.display = 'none';
                document.getElementById('mediumRating').style.display = 'none';
                document.getElementById('detailedRating').style.display = 'block';
            }
            
            // Обновляем BB-код в зависимости от типа
            updateRatingTable();
        }

        function saveData() {
            const data = { participants, tasks, journal };
            localStorage.setItem('questData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('questData');
            if (saved) {
                const data = JSON.parse(saved);
                participants = data.participants || participants;
                tasks = data.tasks || tasks;
                journal = data.journal || journal;
                
                // Если задач нет, добавляем стандартные
                if (tasks.length === 0) {
                    tasks = [...defaultTasks];
                } else {
                    // Удаляем штрафные задания из существующей базы
                    tasks = tasks.filter(task => 
                        task.name !== 'Тропа Рогатого Бога (штраф)' && 
                        task.name !== 'Пир теней (штраф)'
                    );
                }
                
                // Исправляем дату только для участников без даты (старые данные)
                const targetDate = '2024-10-31';
                participants.forEach(participant => {
                    if (!participant.addedDate) {
                        participant.addedDate = targetDate;
                    }
                });
            } else {
                // При первом запуске добавляем стандартные задания
                tasks = [...defaultTasks];
            }
        }

        function exportData() {
            const data = {
                participants,
                tasks,
                journal,
                exportDate: new Date().toLocaleString('ru-RU')
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quest_samaina_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('Данные экспортированы!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.participants && data.tasks && data.journal) {
                        participants = data.participants;
                        tasks = data.tasks;
                        journal = data.journal;
                        
                        // Удаляем штрафные задания при импорте
                        tasks = tasks.filter(task => 
                            task.name !== 'Тропа Рогатого Бога (штраф)' && 
                            task.name !== 'Пир теней (штраф)'
                        );
                        
                        saveData();
                        renderParticipants();
                        updateRatingTable();
                        alert('Данные импортированы успешно!');
                    } else {
                        alert('Неверный формат файла');
                    }
                } catch (error) {
                    alert('Ошибка при импорте: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function toggleExportImport() {
            const panel = document.getElementById('exportImportPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function captureAngerBar() {
            const angerBarContainer = document.getElementById('participantAngerContainer');
            const angerBar = angerBarContainer.querySelector('.anger-bar-participant');
            const percent = document.getElementById('mercyPercent').textContent;
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Размеры шкалы
                const barWidth = 500;
                const barHeight = 60;
                const padding = 15;
                
                canvas.width = barWidth + padding * 2;
                canvas.height = barHeight + padding * 2;
                
                // Прозрачный фон
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Координаты шкалы
                const x = padding;
                const y = padding;
                
                // Градиент фона шкалы (гнев)
                const gradient = ctx.createLinearGradient(x, y, x + barWidth, y);
                gradient.addColorStop(0, '#8B4513');
                gradient.addColorStop(0.5, '#A0522D');
                gradient.addColorStop(1, '#CD5C5C');
                
                // Рисуем фоновую шкалу (гнев)
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, 12);
                ctx.fill();
                
                // Рисуем заполняющую часть (милость)
                const percentValue = parseInt(percent);
                const fillWidth = (barWidth * percentValue) / 100;
                
                // Градиент милости
                const mercyGradient = ctx.createLinearGradient(x, y, x + barWidth, y);
                mercyGradient.addColorStop(0, '#556B2F');
                mercyGradient.addColorStop(0.5, '#6B8E23');
                mercyGradient.addColorStop(1, '#8FBC8F');
                
                ctx.fillStyle = mercyGradient;
                ctx.beginPath();
                ctx.roundRect(x, y, fillWidth, barHeight, 12);
                ctx.fill();
                
                // Рисуем текст с процентом
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px "Sofia Sans Extra Condensed"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.fillText(percent, canvas.width / 2, canvas.height / 2);
                
                // Сохраняем как PNG
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `anger_scale_${new Date().toISOString().split('T')[0]}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    alert('Шкала сохранена как PNG!');
                }, 'image/png');
            } catch (error) {
                alert('Ошибка при сохранении: ' + error.message);
            }
        }

        function clearAllData() {
            if (confirm('Вы уверены? Все данные будут удалены навсегда!')) {
                localStorage.removeItem('questData');
                participants = [];
                tasks = [...defaultTasks];
                journal = [];
                renderParticipants();
                updateRatingTable();
                alert('Данные восстановлены к начальному состоянию');
            }
        }

        let participants = [];
        let tasks = [];
        let journal = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // При переключении на вкладку журнала устанавливаем сегодняшнюю дату
            if (tabName === 'journal') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('journalDate').value = today;
                loadJournalForDate();
            }
        }

        function updateDashboard() {
            const baseAnger = 468;
            const participantCount = participants.length;
            const participantAnger = participantCount * 78; // 78 за каждого участника
            const initialAnger = baseAnger + participantAnger;
            
            // Считаем общую милость из журнала
            let totalMercy = 0;
            journal.forEach(entry => {
                totalMercy += entry.mercy;
            });
            
            const currentAnger = Math.max(0, initialAnger - totalMercy);
            const mercyPercent = initialAnger === 0 ? 0 : Math.round((totalMercy / initialAnger) * 100);

            document.getElementById('baseAnger').textContent = baseAnger;
            document.getElementById('participantCount').textContent = participantCount;
            document.getElementById('participantAnger').textContent = participantAnger;
            document.getElementById('initialAnger').textContent = initialAnger;
            document.getElementById('totalMercy').textContent = totalMercy;
            document.getElementById('currentAnger').textContent = currentAnger;

            // Шкала ведущего: зеленая милость растет слева направо
            const mercyFillLeader = document.getElementById('mercyFillLeader');
            mercyFillLeader.style.width = mercyPercent + '%';
            mercyFillLeader.textContent = totalMercy + ' / ' + initialAnger;

            // Шкала участника: зеленая милость растет слева направо
            document.getElementById('mercyPercent').textContent = mercyPercent + '%';
            const mercyFillParticipant = document.getElementById('mercyFillParticipant');
            mercyFillParticipant.style.width = mercyPercent + '%';

            const angerValue = document.getElementById('currentAnger');
            angerValue.className = 'anger-value';
            if (currentAnger > initialAnger * 0.67) {
                angerValue.classList.add('high');
            } else if (currentAnger > initialAnger * 0.33) {
                angerValue.classList.add('medium');
            } else {
                angerValue.classList.add('low');
            }

            // Обновляем диаграммы с пропорциональным отображением
            const maxWidth = 250; // Максимальная ширина для диаграмм
            
            // Базовый гнев (468) - всегда отображается как фиксированная часть
            document.getElementById('chartBaseAnger').style.width = (baseAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartBaseAnger').textContent = baseAnger;
            
            // Гнев участников
            document.getElementById('chartParticipantAnger').style.width = (participantAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartParticipantAnger').textContent = participantAnger;
            
            // Милость
            document.getElementById('chartMercy').style.width = (totalMercy / initialAnger * maxWidth) + 'px';
            document.getElementById('chartMercy').textContent = totalMercy;
            
            // Оставшийся гнев
            document.getElementById('chartCurrentAnger').style.width = (currentAnger / initialAnger * maxWidth) + 'px';
            document.getElementById('chartCurrentAnger').textContent = currentAnger;
        }

        function updateRatingTable() {
            // Собираем статистику по участникам
            const participantStats = {};
            
            participants.forEach(participant => {
                participantStats[participant.id] = {
                    name: participant.name,
                    total: 0,
                    byCategory: {
                        'druid': 0,
                        'horned': 0,
                        'shadows': 0
                    }
                };
            });
            
            // Заполняем статистику из журнала
            journal.forEach(entry => {
                const participant = participantStats[entry.participantId];
                const task = tasks.find(t => t.id === entry.taskId);
                
                if (participant && task) {
                    participant.total += entry.mercy;
                    
                    if (task.category && participant.byCategory[task.category] !== undefined) {
                        participant.byCategory[task.category] += entry.mercy;
                    }
                }
            });
            
            // Находим лидеров в каждой категории
            const categoryLeaders = {
                'druid': { score: 0, participants: [] },
                'horned': { score: 0, participants: [] },
                'shadows': { score: 0, participants: [] }
            };
            
            Object.values(participantStats).forEach(stat => {
                Object.keys(categoryLeaders).forEach(category => {
                    if (stat.byCategory[category] > categoryLeaders[category].score) {
                        categoryLeaders[category].score = stat.byCategory[category];
                        categoryLeaders[category].participants = [stat.name];
                    } else if (stat.byCategory[category] === categoryLeaders[category].score && stat.byCategory[category] > 0) {
                        categoryLeaders[category].participants.push(stat.name);
                    }
                });
            });
            
            // Сортируем участников по общему счету
            const sortedStats = Object.values(participantStats).sort((a, b) => b.total - a.total);
            
            // Обновляем слепой рейтинг
            updateBlindRating(sortedStats, categoryLeaders);
            
            // Обновляем средний рейтинг
            updateMediumRating(sortedStats, categoryLeaders);
            
            // Обновляем детальный рейтинг
            updateDetailedRating(sortedStats, categoryLeaders);
            
            // Генерируем BB-код в зависимости от текущего типа
            generateBBCode(sortedStats, categoryLeaders);
        }

        function updateBlindRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('blindRatingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем, в каких категориях участник является лидером
                const leaderCategories = [];
                if (categoryLeaders.druid.participants.includes(stat.name)) {
                    leaderCategories.push('druid');
                }
                if (categoryLeaders.horned.participants.includes(stat.name)) {
                    leaderCategories.push('horned');
                }
                if (categoryLeaders.shadows.participants.includes(stat.name)) {
                    leaderCategories.push('shadows');
                }
                
                // Создаем HTML для значков категорий
                const categoryIconsHtml = leaderCategories.map(cat => 
                    `<img src="${categories[cat].icon}" alt="${categories[cat].name}" class="category-icon">`
                ).join('');
                
                return `
                    <tr>
                        <td class="position">${position}</td>
                        <td class="name">
                            <div class="name-with-icons">
                                <span class="participant-name">${stat.name}</span>
                                <div class="category-icons-container">
                                    ${categoryIconsHtml}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateMediumRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('mediumRatingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем, в каких категориях участник является лидером
                const leaderCategories = [];
                if (categoryLeaders.druid.participants.includes(stat.name)) {
                    leaderCategories.push('druid');
                }
                if (categoryLeaders.horned.participants.includes(stat.name)) {
                    leaderCategories.push('horned');
                }
                if (categoryLeaders.shadows.participants.includes(stat.name)) {
                    leaderCategories.push('shadows');
                }
                
                // Создаем HTML для значков категорий
                const categoryIconsHtml = leaderCategories.map(cat => 
                    `<img src="${categories[cat].icon}" alt="${categories[cat].name}" class="category-icon">`
                ).join('');
                
                return `
                    <tr>
                        <td class="position">${position}</td>
                        <td class="name">${stat.name}</td>
                        <td class="score">
                            <div class="score-with-icons">
                                <span class="score-value">${stat.total}</span>
                                ${categoryIconsHtml}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDetailedRating(sortedStats, categoryLeaders) {
            const tableBody = document.getElementById('ratingTableBody');
            
            tableBody.innerHTML = sortedStats.map((stat, index) => {
                const position = index + 1;
                
                // Определяем лидеров для каждой категории
                const isDruidLeader = categoryLeaders.druid.participants.includes(stat.name);
                const isHornedLeader = categoryLeaders.horned.participants.includes(stat.name);
                const isShadowsLeader = categoryLeaders.shadows.participants.includes(stat.name);
                
                return `
                    <tr>
                        <td>${position}</td>
                        <td>${stat.name}</td>
                        <td><strong>${stat.total}</strong></td>
                        <td>${stat.byCategory.druid} ${isDruidLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                        <td>${stat.byCategory.horned} ${isHornedLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                        <td>${stat.byCategory.shadows} ${isShadowsLeader ? '<span class="leader-badge">★</span>' : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateBBCode(sortedStats, categoryLeaders) {
            const bbCodeTextarea = document.getElementById('ratingBBCode');
            
            if (currentRatingType === 'blind') {
                // BB-код для слепого рейтинга
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=250][b]Участник[/b][/width][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем, в каких категориях участник является лидером
                    const leaderCategories = [];
                    if (categoryLeaders.druid.participants.includes(stat.name)) {
                        leaderCategories.push('druid');
                    }
                    if (categoryLeaders.horned.participants.includes(stat.name)) {
                        leaderCategories.push('horned');
                    }
                    if (categoryLeaders.shadows.participants.includes(stat.name)) {
                        leaderCategories.push('shadows');
                    }
                    
                    // Создаем BB-код для значков категорий
                    const categoryIconsBb = leaderCategories.map(cat => 
                        ` [img]${categories[cat].icon}[/img]`
                    ).join('');
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=250]${stat.name}${categoryIconsBb}[/width][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            } else if (currentRatingType === 'medium') {
                // BB-код для среднего рейтинга
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=250][b]Участник[/b][/width][/td][td][center][width=100][b]Общий счет[/b][/width][/center][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем, в каких категориях участник является лидером
                    const leaderCategories = [];
                    if (categoryLeaders.druid.participants.includes(stat.name)) {
                        leaderCategories.push('druid');
                    }
                    if (categoryLeaders.horned.participants.includes(stat.name)) {
                        leaderCategories.push('horned');
                    }
                    if (categoryLeaders.shadows.participants.includes(stat.name)) {
                        leaderCategories.push('shadows');
                    }
                    
                    // Создаем BB-код для значков категорий
                    const categoryIconsBb = leaderCategories.map(cat => 
                        ` [img]${categories[cat].icon}[/img]`
                    ).join('');
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=250]${stat.name}[/width][/td][td][center][width=100]${stat.total}${categoryIconsBb}[/center][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            } else {
                // BB-код для детального рейтинга
                let bbCode = `[table]
[tr][td][width=25][b]#[/b][/width][/td][td][width=150][b]Участник[/b][/width][/td][td][center][width=100][b]Общий счет[/b][/width][/center][/td]
[td][center][width=30][img]${categories.druid.icon}[/img][/width][/center][/td]
[td][center][width=30][img]${categories.horned.icon}[/img][/width][/center][/td]
[td][center][width=30][img]${categories.shadows.icon}[/img][/width][/center][/td][/tr]`;
                
                sortedStats.forEach((stat, index) => {
                    const position = index + 1;
                    
                    // Определяем лидеров для каждой категории
                    const isDruidLeader = categoryLeaders.druid.participants.includes(stat.name);
                    const isHornedLeader = categoryLeaders.horned.participants.includes(stat.name);
                    const isShadowsLeader = categoryLeaders.shadows.participants.includes(stat.name);
                    
                    bbCode += `
[tr][td][width=25]${position}[/width][/td][td][width=150]${stat.name}[/width][/td]
[td][width=100][center]${stat.total}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.druid}${isDruidLeader ? ' ★' : ''}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.horned}${isHornedLeader ? ' ★' : ''}[/center][/width][/td]
[td][width=50][center]${stat.byCategory.shadows}${isShadowsLeader ? ' ★' : ''}[/center][/width][/td][/tr]`;
                });
                
                bbCode += `
[/table]`;
                bbCodeTextarea.value = bbCode;
            }
        }

        function copyBBCode() {
            const bbCodeTextarea = document.getElementById('ratingBBCode');
            bbCodeTextarea.select();
            document.execCommand('copy');
            alert('BB-код скопирован в буфер обмена!');
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ УЧАСТНИКОВ
        function renderParticipants() {
            const grid = document.getElementById('participantsGrid');
            
            grid.innerHTML = participants.map(p => `
                <div class="participant-card">
                    <div class="participant-info">
                        <div class="participant-name">${p.name}</div>
                        <div class="participant-date">Добавлен: ${p.addedDate || 'Неизвестно'}</div>
                    </div>
                    <div class="participant-actions">
                        <button class="delete-btn compact-btn" onclick="deleteParticipant(${p.id})">Удалить</button>
                    </div>
                </div>
            `).join('');

            updateDashboard();
            updateRatingTable();
        }

        function addParticipant() {
            const name = document.getElementById('newParticipantName').value.trim();
            if (name) {
                const id = participants.length > 0 ? Math.max(...participants.map(p => p.id)) + 1 : 1;
                const today = new Date().toISOString().split('T')[0];
                participants.push({ 
                    id, 
                    name, 
                    addedDate: today 
                });
                document.getElementById('newParticipantName').value = '';
                renderParticipants();
                saveData();
            }
        }

        function deleteParticipant(id) {
            participants = participants.filter(p => p.id !== id);
            // Удаляем записи в журнале для этого участника
            journal = journal.filter(j => j.participantId !== id);
            renderParticipants();
            updateRatingTable();
            saveData();
        }

        // ФУНКЦИИ ДЛЯ ЖУРНАЛА

        function loadJournalForDate() {
            const dateInput = document.getElementById('journalDate');
            currentJournalDate = dateInput.value;
            
            if (!currentJournalDate) {
                alert('Пожалуйста, выберите дату');
                return;
            }
            
            // Обновляем список участников для выбранной даты
            updateJournalParticipantSelect();
            
            // Сбрасываем выбранного участника
            document.getElementById('journalParticipantSelect').value = '';
            document.getElementById('tasksContainer').classList.remove('active');
            document.getElementById('startedLaterMessage').style.display = 'none';
            currentJournalParticipant = null;
        }

        function updateJournalParticipantSelect() {
            const select = document.getElementById('journalParticipantSelect');
            select.innerHTML = '<option value="">Выберите участника...</option>';
            
            // Добавляем всех участников, которые были добавлены до выбранной даты или в эту дату
            participants.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
        }

        function showTasksForParticipant() {
            const participantId = parseInt(document.getElementById('journalParticipantSelect').value);
            
            if (!participantId) {
                document.getElementById('tasksContainer').classList.remove('active');
                document.getElementById('startedLaterMessage').style.display = 'none';
                currentJournalParticipant = null;
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) {
                return;
            }
            
            // Проверяем, начал ли участник квест позже выбранной даты
            if (currentJournalDate < participant.addedDate) {
                document.getElementById('tasksContainer').classList.remove('active');
                document.getElementById('startedLaterMessage').style.display = 'block';
                document.getElementById('startedLaterMessage').innerHTML = 
                    `<strong>${participant.name}</strong> начал проходить квест ${participant.addedDate}.<br>Выберите дату не ранее этой.`;
                currentJournalParticipant = null;
                return;
            }
            
            currentJournalParticipant = participantId;
            document.getElementById('tasksContainer').classList.add('active');
            document.getElementById('startedLaterMessage').style.display = 'none';
            
            // Загружаем задания для выбранного участника
            loadTasksForParticipant(participantId);
        }

        function loadTasksForParticipant(participantId) {
            // Очищаем контейнеры с заданиями
            document.getElementById('druidTasks').innerHTML = '';
            document.getElementById('hornedTasks').innerHTML = '';
            document.getElementById('shadowsTasks').innerHTML = '';
            
            // Получаем задания по категориям
            const druidTasks = tasks.filter(t => t.category === 'druid');
            const hornedTasks = tasks.filter(t => t.category === 'horned');
            const shadowsTasks = tasks.filter(t => t.category === 'shadows');
            
            // Отображаем задания для каждой категории
            renderTaskCategory('druidTasks', druidTasks, participantId);
            renderTaskCategory('hornedTasks', hornedTasks, participantId);
            renderTaskCategory('shadowsTasks', shadowsTasks, participantId);
        }

        function renderTaskCategory(containerId, taskList, participantId) {
            const container = document.getElementById(containerId);
            
            taskList.forEach(task => {
                // Проверяем, есть ли уже запись в журнале для этого задания, участника и даты
                const existingEntry = journal.find(j => 
                    j.date === currentJournalDate && 
                    j.participantId === participantId && 
                    j.taskId === task.id
                );
                
                const isCompleted = existingEntry ? true : false;
                const mercyValue = existingEntry ? existingEntry.mercy : task.mercy;
                
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-info">
                        <input type="checkbox" class="task-checkbox" ${isCompleted ? 'checked' : ''} 
                               data-task-id="${task.id}" onchange="toggleTaskCompletion(this, ${task.id}, ${participantId})">
                        <span>${task.name}</span>
                    </div>
                    <input type="number" class="task-mercy-input" value="${mercyValue}" min="0" 
                           data-task-id="${task.id}" onchange="updateTaskMercy(this, ${task.id}, ${participantId})">
                `;
                
                container.appendChild(taskElement);
            });
        }

        function toggleTaskCompletion(checkbox, taskId, participantId) {
            const mercyInput = document.querySelector(`.task-mercy-input[data-task-id="${taskId}"]`);
            const mercyValue = parseInt(mercyInput.value) || 0;
            
            if (checkbox.checked) {
                // Добавляем запись в журнал
                const existingIndex = journal.findIndex(j => 
                    j.date === currentJournalDate && 
                    j.participantId === participantId && 
                    j.taskId === taskId
                );
                
                if (existingIndex === -1) {
                    const id = journal.length > 0 ? Math.max(...journal.map(j => j.id)) + 1 : 1;
                    journal.push({
                        id,
                        date: currentJournalDate,
                        participantId,
                        taskId,
                        mercy: mercyValue
                    });
                } else {
                    // Обновляем существующую запись
                    journal[existingIndex].mercy = mercyValue;
                }
            } else {
                // Удаляем запись из журнала
                journal = journal.filter(j => 
                    !(j.date === currentJournalDate && 
                      j.participantId === participantId && 
                      j.taskId === taskId)
                );
            }
            
            saveData();
            updateDashboard();
            updateRatingTable();
        }

        function updateTaskMercy(input, taskId, participantId) {
            const mercyValue = parseInt(input.value) || 0;
            
            // Находим запись в журнале
            const existingIndex = journal.findIndex(j => 
                j.date === currentJournalDate && 
                j.participantId === participantId && 
                j.taskId === taskId
            );
            
            if (existingIndex !== -1) {
                // Обновляем существующую запись
                journal[existingIndex].mercy = mercyValue;
                saveData();
                updateDashboard();
                updateRatingTable();
            }
        }

        function saveJournalEntries() {
            // Эта функция теперь не нужна, так как изменения сохраняются автоматически
            // при изменении чекбоксов и полей ввода
            alert('Все изменения уже сохранены автоматически!');
        }

        window.addEventListener('load', () => {
            loadData();
            renderParticipants();
            // Устанавливаем слепой рейтинг по умолчанию
            switchRatingType('blind');
            
            // Устанавливаем сегодняшнюю дату в поле выбора даты
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journalDate').value = today;
        });
    </script>
</body>
</html>
